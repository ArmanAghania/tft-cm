{% load humanize %}

<style>

    @media (min-width: 1024px) {  /* Adjust the min-width as per your layout's breakpoint */
    .monthly-lead-trends-container {
        grid-column: span 3; /* Makes the container span two columns */
    }
}
</style>

<div class="container mx-auto p-4 m-4">
    <h2 class="text-2xl font-bold mb-4">Organisor Dashboard</h2>

    <!-- Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <!-- Total Leads -->
        <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Total Leads</h3>
            <p class="text-xl">{{ total_leads }}</p>
        </div>

        <!-- Total Sales -->
        <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Total Sales</h3>
            <p class="text-xl">{{ total_sales.total_amount | default:0 | intcomma }}</p>
        </div>

        <!-- Conversion Rate -->
        <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Conversion Rate</h3>
            <p class="text-xl">{{ conversion_rate | floatformat:2 }}%</p>
        </div>

        <!-- Lead Source Analysis -->
        <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Lead Source Analysis</h3>
            <canvas id="lead-source-chart"></canvas>
        </div>

        <!-- Age Distribution of Sales -->
        <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Age Distribution of Sales</h3>
            <canvas id="age-distribution-chart"></canvas>
        </div>
        <!-- Monthly Sales Performance -->
        <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Monthly Sales Performance</h3>
            <canvas id="monthly-sales-chart"></canvas>
        </div>

        <div class="chart-container monthly-lead-trends-container">
            <div class="bg-white shadow rounded p-4">
                <h3 class="text-lg font-semibold">Monthly Lead Trends</h3>
                <canvas id="monthly-lead-trends-chart"></canvas>
            </div>
        </div>

        <!-- Lead Status -->
        <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Total Lead Statistics</h3>
            <div class="chart-container" style="height: 400px;"> 
                <canvas id="total-lead-stats-chart"></canvas>
            </div>
        </div>
        <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Current Month Lead Statistics</h3>
            <div class="chart-container" style="height: 400px;"> 
                <canvas id="monthly-lead-stats-chart"></canvas>
            </div>
        </div>
        

        <!-- Team Performance -->
        {% comment %} <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Team Performance</h3>
            <ul>
                {% for team, data in team_performance.items %}
                    <li>{{ team }} - Sales: {{ data.total_sales }} - Avg Sale: {{ data.average_sale }}</li>
                {% endfor %}
            </ul>
        </div> {% endcomment %}

        <!-- Additional metrics here... -->
    </div>
    
    
    
    <!-- Charts and Graphs Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <!-- Sales Trends Chart -->
        <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Sales Trends</h3>
            <canvas id="sales-trends-chart"></canvas>
        </div>

        <!-- Monthly Sales Performance Chart -->
        <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Monthly Sales Performance</h3>
            <canvas id="monthly-sales-performance-chart"></canvas>
        </div>

        <!-- Lead Conversion Over Time Chart -->
        <div class="bg-white shadow rounded p-4">
            <h3 class="text-lg font-semibold">Lead Conversion Over Time</h3>
            <canvas id="lead-conversion-over-time-chart"></canvas>
        </div>

        <!-- Additional charts can be added here -->
    </div>

    {{ sales_trends|json_script:"salesTrendsData" }}
    {{ monthly_sales_performance|json_script:"monthlySalesPerformanceData" }}
    {{ lead_conversion_over_time|json_script:"leadConversionOverTimeData" }} 
    {{ lead_source_labels|json_script:"leadSourceLabels" }}
    {{ lead_source_values|json_script:"leadSourceValues" }}
    {{ age_distribution_of_sales|json_script:"ageDistributionData" }}
    
    <script>
        
    
        // Example data from Django context
        var salesTrendsData = JSON.parse(document.getElementById('salesTrendsData').textContent);
        var monthlySalesPerformanceData = JSON.parse(document.getElementById('monthlySalesPerformanceData').textContent);
        var leadConversionOverTimeData = JSON.parse(document.getElementById('leadConversionOverTimeData').textContent);
        var leadSourceLabels = JSON.parse(document.getElementById('leadSourceLabels').textContent);
        var leadSourceValues = JSON.parse(document.getElementById('leadSourceValues').textContent);
        var ageDistributionData = JSON.parse(document.getElementById('ageDistributionData').textContent);

        // Initialize your charts using this data
        // Example for Sales Trends Chart
        var ctxSalesTrends = document.getElementById('sales-trends-chart').getContext('2d');
        var salesTrendsChart = new Chart(ctxSalesTrends, {
            type: 'line',
            data: {
                labels: Object.keys(salesTrendsData),
                datasets: [{
                    label: 'Sales Trends',
                    data: Object.values(salesTrendsData),
                    // ... other chart options ...
                }]
            },
            // ... other chart options ...
        });

        var ctxSalesTrends = document.getElementById('monthly-sales-performance-chart').getContext('2d');
        var salesTrendsChart = new Chart(ctxSalesTrends, {
            type: 'line',
            data: {
                labels: Object.keys(monthlySalesPerformanceData),
                datasets: [{
                    label: 'Monthly Sale Performance',
                    data: Object.values(monthlySalesPerformanceData),
                    // ... other chart options ...
                }]
            },
            // ... other chart options ...
        });

        var ctxSalesTrends = document.getElementById('lead-conversion-over-time-chart').getContext('2d');
        var salesTrendsChart = new Chart(ctxSalesTrends, {
            type: 'line',
            data: {
                labels: Object.keys(leadConversionOverTimeData),
                datasets: [{
                    label: 'Lead Conversion Over Time',
                    data: Object.values(leadConversionOverTimeData),
                    // ... other chart options ...
                }]
            },
            // ... other chart options ...
        });

        function loadAgeDistributionChart(organisationId) {
            $.ajax({
                url: `/dashboard/api/age-distribution/${organisationId}/`,
                success: function(data) {
                    var labels = [];
                    var chartData = [];
        
                    for (var ageGroup in data) {
                        if (data.hasOwnProperty(ageGroup)) {
                            labels.push(ageGroup);
                            chartData.push(data[ageGroup]);
                        }
                    }
        
                    var ctx = document.getElementById('age-distribution-chart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Age Distribution',
                                data: chartData,
                                backgroundColor: 'rgba(0, 123, 255, 0.5)',
                                borderColor: 'rgba(0, 123, 255, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                },
                error: function(error) {
                    console.error("Error loading age distribution data:", error);
                }
            });
        }
        
        $(document).ready(function() {
            var organisationId = "{{ request.user.userprofile.id }}";
            loadAgeDistributionChart(organisationId);
        });
        

    function loadLeadSourceChart(organisationId) {
        $.ajax({
            url: `/dashboard/api/lead-source/${organisationId}/`,
            success: function(data) {
                var ctx = document.getElementById('lead-source-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Lead Sources',
                            data: data.values,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },
            error: function(error) {
                console.error("Error loading lead source data:", error);
            }
        });
    }
    
    $(document).ready(function() {
        var organisationId = "{{ request.user.userprofile.id }}";
        loadLeadSourceChart(organisationId);
    });

    function renderPieChart(canvasId, data, title) {
        var ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Total Leads', 'Converted Leads'],
                datasets: [{
                    label: title,
                    data: [data.total_leads, data.converted_leads],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutoutPercentage: 60, // Adjust for doughnut thickness
                aspectRatio: 1, // Default aspect ratio, you can adjust this as needed
                layout: {
                    padding: {
                        top: 20,
                        bottom: 20
                    }
                },
                plugins: {
                    datalabels: {
                        color: '#fff',
                    },
                    centerText: {
                        text: 'Conversion\n' + data.conversion_rate.toFixed(2) + '%',
                    }
                }
            },
            plugins: [{
                beforeDraw: function(chart) {
                    if (!chart.ctx) return;
                    
                    var width = chart.chartArea.right - chart.chartArea.left;
                    var height = chart.chartArea.bottom - chart.chartArea.top;
                    var ctx = chart.ctx;
    
                    ctx.save();
                    var fontSize = Math.min(height / 25, width / 25); // Adjust font size based on chart size
                    ctx.font = fontSize + "px sans-serif";
                    ctx.textBaseline = "middle";
                    ctx.textAlign = "center";
    
                    var text = chart.options.plugins.centerText.text;
                    var textX = chart.chartArea.left + width / 2;
                    var textY = chart.chartArea.top + height / 2;
    
                    ctx.fillText(text, textX, textY);
                    ctx.restore();
                }
            }]
        });
    }
    
    
    
    
    function loadLeadStatsCharts(organisationId) {
        $.ajax({
            url: `/dashboard/api/lead-stats/${organisationId}/`,
            success: function(data) {
                renderPieChart('total-lead-stats-chart', data.total_stats, 'Total Lead Statistics');
                renderPieChart('monthly-lead-stats-chart', data.monthly_stats, 'Current Month Lead Statistics');
            },
            error: function(error) {
                console.error("Error loading lead stats data:", error);
            }
        });
    }
    
    $(document).ready(function() {
        var organisationId = "{{ request.user.userprofile.id }}";
        loadLeadStatsCharts(organisationId);
    });

    function loadMonthlySalesChart(organisationId) {
        $.ajax({
            url: `/dashboard/api/monthly-sales/${organisationId}/`,
            success: function(data) {
                var ctx = document.getElementById('monthly-sales-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            label: 'Monthly Sales',
                            data: Object.values(data),
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {  // Note the change here from 'yAxes' to 'y'
                                beginAtZero: true
                            }
                        }
                    }
                });
            },
            error: function(error) {
                console.error("Error loading monthly sales data:", error);
            }
        });
    }
    
    
    $(document).ready(function() {
        var organisationId = "{{ request.user.userprofile.id }}";
        loadMonthlySalesChart(organisationId);
    });

    function loadMonthlyLeadTrendsChart(organisationId) {
        $.ajax({
            url: `/dashboard/api/monthly-lead-trends/${organisationId}/`,
            success: function(data) {
                var labels = Object.keys(data);
                var totalLeads = labels.map(label => data[label].total);
                var convertedLeads = labels.map(label => data[label].converted);
                console.log(data)
                var ctx = document.getElementById('monthly-lead-trends-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Leads',
                            data: totalLeads,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            fill: false
                        }, {
                            label: 'Converted Leads',
                            data: convertedLeads,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            fill: false
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            },
                            x: {
                                maxTicksLimit: null // Display all x-axis labels
                            }
                        }
                    }
                });
            },
            error: function(error) {
                console.error("Error loading monthly lead trends data:", error);
            }
        });
    }
    
    $(document).ready(function() {
        var organisationId = "{{ request.user.userprofile.id }}";
        loadMonthlyLeadTrendsChart(organisationId);
    });
    
    
    
        // Initialize Monthly Sales Performance Chart
        // Similar to above, use 'monthlySalesData'
    
        // Initialize Lead Conversion Over Time Chart
        // Similar to above, use 'conversionData'
    
        // Add more chart initializations as needed
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
